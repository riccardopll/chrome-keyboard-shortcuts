name: CI - Package Extension

on:
  push:
    branches:
      - "main"

permissions:
  contents: write

jobs:
  package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set CalVer in manifest
        id: calver
        run: |
          set -euo pipefail

          year=$(date -u +%Y)
          month=$(date -u +%-m)
          day=$(date -u +%-d)
          build="${GITHUB_RUN_NUMBER}"

          if [ "$build" -gt 65535 ]; then
            echo "GITHUB_RUN_NUMBER exceeds Chrome manifest segment max (65535): $build"
            exit 1
          fi

          calver="${year}.${month}.${day}.${build}"
          version_name="${calver}"

          jq --arg version "$calver" --arg version_name "$version_name" \
            '.version = $version | .version_name = $version_name' \
            manifest.json > manifest.json.tmp
          mv manifest.json.tmp manifest.json

          echo "version=$calver" >> "$GITHUB_OUTPUT"
          echo "version_name=$version_name" >> "$GITHUB_OUTPUT"
          echo "Using manifest version: $calver"

      - name: Package extension
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist/package

          rsync -av --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude 'dist' \
            --exclude '*.md' \
            --exclude 'package*.json' \
            --exclude '.prettier*' \
            ./ dist/package/

          (
            cd dist/package
            zip -r ../extension.zip .
          )

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension-${{ steps.calver.outputs.version }}
          path: dist/extension.zip

      - name: Create GitHub release with package
        if: ${{ github.run_attempt == 1 }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ steps.calver.outputs.version }}
          target_commitish: ${{ github.sha }}
          name: Build ${{ steps.calver.outputs.version }}
          prerelease: true
          make_latest: false
          body: |
            Automated package for commit `${{ github.sha }}`.
          files: dist/extension.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
