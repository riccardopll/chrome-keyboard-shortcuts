name: Package and publish extension

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      publish_now:
        description: "Publish to Chrome Web Store after upload"
        required: true
        default: true
        type: boolean

jobs:
  package-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Package extension
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist/package

          rsync -av --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude 'dist' \
            --exclude '*.md' \
            --exclude 'package*.json' \
            --exclude '.prettier*' \
            ./ dist/package/

          (
            cd dist/package
            zip -r ../extension.zip .
          )

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension-${{ github.ref_name }}
          path: dist/extension.zip

      - name: Get Chrome Web Store access token
        id: auth
        env:
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
        run: |
          set -euo pipefail
          token_response=$(curl --fail-with-body -sS \
            -X POST https://oauth2.googleapis.com/token \
            -d "client_id=${CHROME_CLIENT_ID}" \
            -d "client_secret=${CHROME_CLIENT_SECRET}" \
            -d "refresh_token=${CHROME_REFRESH_TOKEN}" \
            -d "grant_type=refresh_token")

          access_token=$(echo "$token_response" | jq -r '.access_token')
          if [ -z "$access_token" ] || [ "$access_token" = "null" ]; then
            echo "Failed to retrieve access token"
            echo "$token_response"
            exit 1
          fi

          echo "::add-mask::$access_token"
          echo "access_token=$access_token" >> "$GITHUB_OUTPUT"

      - name: Upload package to Chrome Web Store
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
          CHROME_PUBLISHER_ID: ${{ secrets.CHROME_PUBLISHER_ID }}
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
        run: |
          set -euo pipefail
          curl --fail-with-body -sS \
            -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/zip" \
            --data-binary @dist/extension.zip \
            "https://chromewebstore.googleapis.com/upload/v2/publishers/${CHROME_PUBLISHER_ID}/items/${CHROME_EXTENSION_ID}:upload"

      - name: Publish extension in Chrome Web Store
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.publish_now == 'true' }}
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
          CHROME_PUBLISHER_ID: ${{ secrets.CHROME_PUBLISHER_ID }}
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
        run: |
          set -euo pipefail
          curl --fail-with-body -sS \
            -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            "https://chromewebstore.googleapis.com/v2/publishers/${CHROME_PUBLISHER_ID}/items/${CHROME_EXTENSION_ID}:publish"
