name: Manual - Publish to Chrome Web Store

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set CalVer in manifest
        id: calver
        run: |
          set -euo pipefail

          year=$(date -u +%Y)
          month=$(date -u +%-m)
          day=$(date -u +%-d)
          build="${GITHUB_RUN_NUMBER}"

          if [ "$build" -gt 65535 ]; then
            echo "GITHUB_RUN_NUMBER exceeds Chrome manifest segment max (65535): $build"
            exit 1
          fi

          calver="${year}.${month}.${day}.${build}"
          version_name="${calver}"

          jq --arg version "$calver" --arg version_name "$version_name" \
            '.version = $version | .version_name = $version_name' \
            manifest.json > manifest.json.tmp
          mv manifest.json.tmp manifest.json

          echo "version=$calver" >> "$GITHUB_OUTPUT"
          echo "version_name=$version_name" >> "$GITHUB_OUTPUT"
          echo "Using manifest version: $calver"

      - name: Package extension
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist/package

          rsync -av --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude 'dist' \
            --exclude '*.md' \
            --exclude 'package*.json' \
            --exclude '.prettier*' \
            ./ dist/package/

          (
            cd dist/package
            zip -r ../extension.zip .
          )

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension-${{ steps.calver.outputs.version }}
          path: dist/extension.zip

      - name: Get Chrome Web Store access token
        id: auth
        env:
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
        run: |
          set -euo pipefail
          token_response=$(curl --fail-with-body -sS \
            -X POST https://oauth2.googleapis.com/token \
            -d "client_id=${CHROME_CLIENT_ID}" \
            -d "client_secret=${CHROME_CLIENT_SECRET}" \
            -d "refresh_token=${CHROME_REFRESH_TOKEN}" \
            -d "grant_type=refresh_token")

          access_token=$(echo "$token_response" | jq -r '.access_token')
          if [ -z "$access_token" ] || [ "$access_token" = "null" ]; then
            echo "Failed to retrieve access token"
            echo "$token_response"
            exit 1
          fi

          echo "::add-mask::$access_token"
          echo "access_token=$access_token" >> "$GITHUB_OUTPUT"

      - name: Upload package to Chrome Web Store
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
          CHROME_PUBLISHER_ID: ${{ secrets.CHROME_PUBLISHER_ID }}
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
        run: |
          set -euo pipefail
          curl --fail-with-body -sS \
            -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/zip" \
            --data-binary @dist/extension.zip \
            "https://chromewebstore.googleapis.com/upload/v2/publishers/${CHROME_PUBLISHER_ID}/items/${CHROME_EXTENSION_ID}:upload"

      - name: Publish extension in Chrome Web Store
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
          CHROME_PUBLISHER_ID: ${{ secrets.CHROME_PUBLISHER_ID }}
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
        run: |
          set -euo pipefail
          curl --fail-with-body -sS \
            -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            "https://chromewebstore.googleapis.com/v2/publishers/${CHROME_PUBLISHER_ID}/items/${CHROME_EXTENSION_ID}:publish"
